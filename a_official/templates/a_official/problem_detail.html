{% extends '_base.html' %}
{% load official_templatetags %}

{% block main %}
    {{ info|json_script:'info' }}
    <div class="pagetitle">
        <h1>{{ icon_menu|safe }} 기출문제
            <span class="fs-6 text-secondary">{{ problem.full_reference }}</span>
            {% if user.is_staff %}
                <a class="btn btn-sm btn-outline-primary ms-1"
                   href="{% url 'admin:a_official_problem_change' problem.id %}" target="admin">
                    관리자 페이지
                </a>
            {% endif %}
        </h1>
        <nav>
            <ol class="breadcrumb" hx-target="#main" hx-swap="innerHTML swap:0.25s" hx-boost="true">
                <li class="breadcrumb-item">
                    <a href="{% url 'index' %}">Home</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'official:base' %}">Official</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ problem.get_absolute_url }}" class="active">
                        {{ problem.reference }}
                    </a>
                </li>
            </ol>
        </nav>
    </div><!-- Page Title End -->

    <section class="section">
        <div class="row">
            <article class="col-xxl-8">
                <problem id="containerProblem" class="card htmx-fade-in htmx-fade-out">
                    <div class="card-body">
                        <div class="card-title mb-0 row">
                            <div class="d-flex align-items-center fs-6">
                                <div class="d-flex align-items-center">
                                    {% include 'a_official/snippets/navigation_container.html' %}
                                </div>
                            </div>
                            <div class="d-flex align-items-center fs-6">
                                <div class="text-nowrap me-auto">
                                    {% custom_icons user problem custom_data %}
                                </div>
                                <div class="ms-auto justify-content-end">
                                    {% include 'a_official/snippets/solve_container.html' %}
                                </div>
                            </div>
                        </div>
                        <div id="problemQuestion" class="border-top pt-3 htmx-fade-in htmx-fade-out">
                            <div class="d-flex">
                                <h5 class="lh-base text-nowrap mb-2 me-2 fw-bold text-primary">
                                    문&nbsp;{{ problem.number|add_space }}.
                                </h5>
                                <h5 class="lh-base mb-0 fw-bold text-secondary">
                                    {{ problem.question }}
                                </h5>
                            </div>
                        </div>
                        <div id="problemDetail" class="htmx-fade-in htmx-fade-out">
                            <div class="d-flex flex-wrap align-items-start justify-content-start ms-4">
                                {{ problem.data|safe }}
                            </div>
                        </div>
                    </div>
                </problem>
            </article>

            <div class="col-xxl-4">
                <div class="row">
                    <article class="col-md-6 col-xxl-12">
                        <memo id="containerMemo" class="card htmx-fade-in htmx-fade-out">
                            <div class="card-body">
                                <div id="accordionMemo" class="accordion accordion-flush">
                                    <div class="accordion-item">
                                        <h2 id="headingMemo" class="accordion-header">
                                            <button class="accordion-button" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#collapseMemo"
                                                    aria-expanded="true" aria-controls="collapseMemo">
                                                <span class="badge bg-warning me-2">{{ icon_memo.white|safe }} 메모</span>
                                                <span class="small text-warning fw-bold">
                                                    나만 볼 수 있는 메모를 남겨보세요.
                                                </span>
                                            </button>
                                        </h2>
                                        <hr class="border-secondary mt-0">
                                        <div id="collapseMemo" class="accordion-collapse collapse show"
                                             aria-labelledby="headingMemo" data-bs-parent="#accordionMemo">
                                            <div id="collapseMemoContent" class="htmx-fade-in htmx-fade-out"
                                                 hx-target="#collapseMemoContent" hx-swap="innerHTML swap:0.25s">
                                                {% if user.is_authenticated %}
                                                    {% include 'a_official/snippets/memo_container.html' %}
                                                {% else %}
                                                    {% partial need_login %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </memo>
                    </article>

                    <article class="col-md-6 col-xxl-12">
                        <tag id="containerTag" class="card htmx-fade-in htmx-fade-out">
                            <div class="card-body">
                                <div id="accordionTag" class="accordion accordion-flush">
                                    <div class="accordion-item">
                                        <h2 id="headingTag" class="accordion-header">
                                            <button class="accordion-button" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#collapseTag"
                                                    aria-expanded="true" aria-controls="collapseTag">
                                                <span class="badge bg-primary me-2">{{ icon_tag.white|safe }} 태그</span>
                                                <span class="small text-primary fw-bold">
                                                    나만 볼 수 있는 태그를 남겨보세요.
                                                </span>
                                            </button>
                                        </h2>
                                        <hr class="border-secondary mt-0">
                                        <div id="collapseTag" class="accordion-collapse collapse show"
                                             aria-labelledby="headingTag" data-bs-parent="#accordionTag">
                                            <div id="collapseTagContent" class="htmx-fade-in htmx-fade-out"
                                                 hx-target="#collapseTagContent" hx-swap="innerHTML swap:0.25s">
                                                {% if user.is_authenticated %}
                                                    <div class="tw-text-sm tw-mb-2 tw-px-2">
                                                        <input id="problemTag{{ problem.id }}"
                                                               placeholder='태그를 입력해주세요' type="hidden"
                                                               data-tagify data-problem-id="{{ problem.id }}"
                                                               data-tags="{{ tags|join:',' }}">
                                                    </div>
                                                {% else %}
                                                    {% partial need_login %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </tag>
                    </article>
                </div>
            </div>
        </div>

        <div class="row">
{#            <article class="col-12">{% partial container_comment %}</article>#}
        </div>
    </section>
{% endblock main %}

{% partialdef container_comment %}
    <comment id="containerComment" class="card htmx-fade-in htmx-fade-out">
        <div class="card-body">
            <div id="accordionComment" class="accordion accordion-flush">
                <div class="accordion-item">
                    <h2 id="headingComment" class="accordion-header">
                        <button class="accordion-button" type="button"
                                data-bs-toggle="collapse" data-bs-target="#collapseComment"
                                aria-expanded="true" aria-controls="collapseComment">
                            <span class="badge bg-success me-2">{{ icon_question.white|safe }} 질문</span>
                            <span class="small text-success fw-bold">
                                문제에 관한 질문이나 댓글을 남겨보세요.
                            </span>
                        </button>
                    </h2>
                    <div class="d-flex justify-content-end mb-3">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-success" title="새로고침"
                                    hx-target="#collapseCommentContent" hx-swap="innerHTL swap:0.25s"
                                    hx-get="">
{#                                    hx-get="{% url 'official:comment_container' problem.id %}">#}
                                <i class="fa-solid fa-rotate-right"></i> 새로고침
                            </button>
                            <button class="btn btn-sm btn-outline-success" title="질문하기"
                                    hx-target="#modalContainer" data-bs-toggle="modal" data-bs-target="#modalContainer"
                                    hx-get="">
{#                                    hx-get="{% url 'official:comment_create' problem.id %}">#}
                                {{ icon_question.filter|safe }} 질문하기
                            </button>
                    {#        <button class="btn btn-sm btn-outline-success"#}
                    {#                hx-get="{% url 'official:comment_container' problem_id %}">#}
                    {#            <i class="fa-regular fa-window-maximize"></i>#}
                    {#            새 창#}
                    {#        </button>#}
                        </div>
                    </div>
                    <hr class="border-secondary"/>
                    <div id="collapseComment" class="accordion-collapse collapse show"
                         aria-labelledby="headingComment" data-bs-parent="#accordionComment">
                        <div id="collapseCommentContent" class="htmx-fade-in htmx-fade-out"
                             hx-target="#collapseCommentContent" hx-swap="innerHTML swap:0.25s">
                            {% if user.is_authenticated %}
{#                                <div hx-trigger="load" hx-get="{% url 'official:comment_container' problem.id %}"></div>#}
                            {% else %}
                                {% partial need_login %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </comment>
{% endpartialdef container_comment %}

{% partialdef need_login %}
    <ul class="list-group">
        <li class="list-group-item">
            <a class="text-secondary" hx-target="#main"
               hx-boost="true" hx-swap="innerHTML swap:0.25s" hx-trigger="click"
               href="{% url 'account_login' %}?next={{ problem.get_absolute_url }}">
                로그인이 필요합니다
            </a>
        </li>
    </ul>
{% endpartialdef need_login %}
